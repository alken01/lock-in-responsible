// Prisma schema for Lock-In Responsible

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // Can be changed to "sqlite" for development
  url      = env("DATABASE_URL")
}

// User model
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Preferences
  preferences Json @default("{\"codeLength\":6,\"codeExpiry\":300,\"notifications\":{\"email\":true,\"push\":false}}")

  // Statistics
  totalGoalsCompleted Int @default(0)
  currentStreak       Int @default(0)
  longestStreak       Int @default(0)

  // Relationships
  devices       Device[]
  goals         Goal[]
  verifications Verification[]
  integrations  Integration[]
  refreshTokens RefreshToken[]
  auditLogs     AuditLog[]

  @@index([email])
}

// Refresh token for JWT authentication
model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  revoked   Boolean  @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

// Device model (ESP32 locks)
model Device {
  id              String    @id @default(cuid())
  name            String
  macAddress      String    @unique
  apiKey          String    @unique
  userId          String
  status          String    @default("offline") // online, offline, error
  lastSeen        DateTime?
  firmwareVersion String    @default("1.0.0")
  batteryLevel    Int?
  wifiRssi        Int?
  lockState       String    @default("locked") // locked, unlocked
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Settings
  settings Json @default("{\"autoLockDelay\":10,\"unlockDuration\":5,\"buzzerEnabled\":true}")

  // Relationships
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  goals       Goal[]
  unlockCodes UnlockCode[]
  deviceLogs  DeviceLog[]

  @@index([userId])
  @@index([macAddress])
  @@index([apiKey])
}

// Goal model
model Goal {
  id          String    @id @default(cuid())
  title       String
  description String?
  type        String // github_commits, github_pr, github_issues, code_lines, time_based, custom
  target      Int       @default(1)
  progress    Int       @default(0)
  status      String    @default("pending") // pending, completed, failed
  dueDate     DateTime?
  completedAt DateTime?
  userId      String
  deviceId    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Verification configuration
  verificationType   String @default("manual") // manual, github, llm, custom
  verificationConfig Json   @default("{}")

  // Relationships
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  device        Device?        @relation(fields: [deviceId], references: [id], onDelete: SetNull)
  verifications Verification[]

  @@index([userId])
  @@index([deviceId])
  @@index([status])
  @@index([dueDate])
}

// Verification model
model Verification {
  id         String    @id @default(cuid())
  goalId     String
  userId     String
  status     String    @default("pending") // pending, verified, rejected
  proofType  String // screenshot, text, github, custom
  proofUrl   String?
  proofText  String?
  confidence Float?
  feedback   String?
  verifiedAt DateTime?
  createdAt  DateTime  @default(now())

  // LLM response metadata
  llmProvider String? // openai, anthropic
  llmModel    String?
  llmResponse Json?

  // Relationships
  goal Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([goalId])
  @@index([userId])
  @@index([status])
}

// Unlock code model
model UnlockCode {
  id        String    @id @default(cuid())
  code      String
  deviceId  String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  // Relationships
  device Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([deviceId])
  @@index([code])
  @@index([expiresAt])
}

// Integration model (GitHub, etc.)
model Integration {
  id          String   @id @default(cuid())
  provider    String // github, jira, trello, etc.
  userId      String
  username    String?
  accessToken String
  refreshToken String?
  tokenExpiry DateTime?
  metadata    Json     @default("{}")
  connectedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId])
  @@index([provider])
}

// Device log model
model DeviceLog {
  id        String   @id @default(cuid())
  deviceId  String
  eventType String // heartbeat, unlock_success, unlock_fail, error, etc.
  metadata  Json     @default("{}")
  timestamp DateTime @default(now())

  // Relationships
  device Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([deviceId])
  @@index([eventType])
  @@index([timestamp])
}

// Audit log model
model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String // login, goal_created, device_paired, etc.
  resourceId String?
  metadata   Json     @default("{}")
  ipAddress  String?
  userAgent  String?
  timestamp  DateTime @default(now())

  // Relationships
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([timestamp])
}
